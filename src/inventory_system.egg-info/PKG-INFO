Metadata-Version: 2.4
Name: inventory-system
Version: 0.1.0
Summary: Inventory simulator with pandas-based state management
Requires-Python: >=3.13
Description-Content-Type: text/markdown
Requires-Dist: pandas>=2.2.0
Requires-Dist: numpy>=1.26.0
Requires-Dist: matplotlib>=3.10.8
Provides-Extra: dev
Requires-Dist: pytest>=8.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.1.0; extra == "dev"
Provides-Extra: viz
Requires-Dist: matplotlib>=3.8.0; extra == "viz"

# Inventory Simulator with Kalman Filter

A Python library demonstrating **Kalman filter** application in a **partial observability** scenario. Built with pandas and numpy, this simulator models an inventory system where an observer can only see one shelf at a time and must estimate the total number of items using a 1D Kalman filter.

## Overview

The Inventory Simulator is an educational tool that demonstrates:
- **Kalman filter estimation** with partial observations
- **State estimation** under uncertainty
- **Sensor fusion** concepts (combining stale and fresh observations)
- **Conservation constraints** in dynamic systems

### Key Features

✅ **Dual Architecture**: Simulator (ground truth) + Observer (partial estimates)
✅ **Kalman Filter**: Estimates total items from partial observations
✅ **Per-Item Movement Probability**: Realistic dynamics with configurable churn
✅ **Round-Robin Observation**: One shelf observed per timestep
✅ **Partial Observability**: One shelf never observed (requires inference)
✅ **Complete Analytics**: Track estimation error and uncertainty over time
✅ **Matplotlib Visualizations**: Beautiful plots of convergence and performance

## Quick Start

### Installation

```bash
# Clone the repository
git clone <repository-url>
cd inventory_system

# Install in development mode
pip install -e .

# Install with visualization support
pip install -e ".[viz]"
```

### Run the Demo

```bash
# Main demonstration (generates plots)
python main.py

# Basic simulation (text output)
python examples/basic_simulation.py

# Full visualization showcase
python examples/visualization_demo.py
```

### Programmatic Usage

```python
from inventory_simulator import SimulatorConfig, SimulationRunner
from inventory_simulator.visualization import plot_total_estimation_over_time

# Configure system
config = SimulatorConfig(
    num_shelves=20,           # Circular shelf arrangement
    shelf_capacity=50,        # Max items per shelf
    total_items=100,          # Conserved quantity
    unobserved_shelf_id=0,    # Shelf never observed
    movement_probability=0.01  # 1% of items move per timestep
)

# Run simulation
runner = SimulationRunner(config, seed=42)
results = runner.run(num_steps=1000, report_interval=100)

# Analyze results
for analytics in results.analytics_history:
    print(f"Step {analytics['step']:4d}: "
          f"Error = {analytics['total_error_pct']:.1f}%, "
          f"Uncertainty = {analytics['kalman_uncertainty']:.2f}")

# Visualize
plot_total_estimation_over_time(
    results.analytics_history,
    true_total=config.total_items,
    save_path="kalman_convergence.png"
)
```

## Architecture

### Core Components

1. **Simulator** (`simulator.py`)
   - Maintains ground truth state (all shelf quantities)
   - Processes per-item movement probability each timestep
   - Uses binomial distribution for efficient movement calculations

2. **Observer** (`observer.py`)
   - Round-robin observation pattern (skips one shelf)
   - Updates shelf estimates when observed
   - **1D Kalman Filter** estimates total items
   - Tracks uncertainty (staleness) for each shelf

3. **Kalman Filter** (embedded in Observer)
   - **State**: `x = [total_items]` (scalar)
   - **State Transition**: `F = 1` (total is constant)
   - **Process Noise**: `Q = 0.1` (small, allows adaptation)
   - **Measurement**: `z = sum(estimated_shelf_quantities)`
   - **Measurement Noise**: `R = f(staleness)` (function of uncertainty)

4. **Analytics** (`analytics.py`)
   - Total estimation error and percentage error
   - Mean Absolute Error (MAE) for observed shelves
   - Shelf-specific error calculations
   - Comprehensive performance reports

5. **SimulationRunner** (`runner.py`)
   - Orchestrates simulation loop
   - Collects analytics at intervals
   - Logs all events (movements + observations)
   - Returns complete results for analysis

6. **Visualization** (`visualization.py`)
   - Total estimation vs true total (with uncertainty bands)
   - Kalman uncertainty reduction over time
   - Estimation error convergence
   - Shelf comparison (ground truth vs estimates)
   - Uncertainty heatmap (staleness visualization)

### Data Flow

```
Each Timestep:
  1. Simulator.step()
     └─> Process all items with movement_probability
     └─> Update ground truth state
     └─> Return MovementEvent

  2. Observer.observe()
     └─> Observe next shelf in round-robin
     └─> Update shelf estimate (perfect observation)
     └─> Reset uncertainty for observed shelf
     └─> Increment uncertainty for all others
     └─> Kalman Filter Update:
         - Predict: x_pred = x (total constant)
         - Measure: z = sum(shelf estimates)
         - Update: x = x_pred + K(z - x_pred)
     └─> Return ObservationEvent

  3. Analytics Collection (at intervals)
     └─> Calculate total error
     └─> Calculate MAE for observed shelves
     └─> Track Kalman uncertainty
```

## The Kalman Filter

### Why Kalman Filter?

The inventory system is **ideal for Kalman filter demonstration** because:

1. **Conservation Constraint**: Total items never changes → state transition is identity
2. **Partial Observations**: Can't see all shelves → need to estimate
3. **Measurement Uncertainty**: Stale observations → time-varying measurement noise
4. **Continuous Updates**: New observation each timestep → filter continuously refines

### How It Works

The Kalman filter maintains two key quantities:

- **State Estimate** (`x`): Best guess of total items
- **Uncertainty** (`P`): Confidence in that estimate (covariance)

**Prediction Step** (constant total):
```
x_pred = x              # Total doesn't change
P_pred = P + Q          # Add small process noise
```

**Update Step** (new observation):
```
z = sum(shelf_estimates)           # Measurement
R = f(total_uncertainty)            # Measurement noise (staleness)
K = P_pred / (P_pred + R)          # Kalman gain
x = x_pred + K(z - x_pred)         # Updated estimate
P = (1 - K) * P_pred               # Updated uncertainty
```

**Key Insight**: The Kalman gain `K` automatically balances:
- High uncertainty (large `P`) → trust the measurement more
- High staleness (large `R`) → trust the prediction more

### Performance

Typical convergence with default settings (20 shelves, 100 items, 1% movement):

| Steps | Error (%) | Uncertainty |
|-------|-----------|-------------|
| 0     | 100.0     | 1000.0      |
| 200   | 5.7       | 4.3         |
| 1000  | 5.4       | 7.5         |
| 5000  | 4.2       | 9.8         |

The filter converges to **<10% error** within 200 steps and maintains accuracy despite continuous item movements.

## Configuration

```python
SimulatorConfig(
    num_shelves=20,            # Number of shelves (circular)
    shelf_capacity=50,         # Max items per shelf
    total_items=100,           # Total items (conserved)
    unobserved_shelf_id=0,     # Shelf never observed
    movement_probability=0.01  # Per-item movement probability
)
```

### Parameter Effects

- **num_shelves**: More shelves → longer round-robin cycle → higher staleness
- **movement_probability**: Higher → more dynamics → harder to estimate
- **total_items**: Larger systems test filter scaling
- **unobserved_shelf_id**: Creates fundamental partial observability challenge

## Examples

### Basic Simulation
```bash
python examples/basic_simulation.py
```

Runs 1000 steps and prints convergence table:
```
  Step   True  Estimated  Error %   KF Unc    MAE
------------------------------------------------------------
     0    100       0.00   100.00  1000.00   0.00
   200    100      94.28     5.72     4.25   0.47
   400    100      96.25     3.75     5.26   0.63
   600    100      95.33     4.67     6.11   0.68
   800    100      95.81     4.19     6.86   0.53
  1000    100      94.61     5.39     7.54   0.32
```

### Visualization Demo
```bash
python examples/visualization_demo.py
```

Generates 5 plots:
- `total_estimation.png` - Kalman estimate vs true total
- `kalman_uncertainty.png` - Uncertainty reduction
- `estimation_error.png` - Error percentage over time
- `shelf_comparison.png` - Final state comparison
- `uncertainty_heatmap.png` - Staleness across shelves

## Testing

```bash
# Run all tests
pytest tests/

# Run with coverage
pytest tests/ --cov=src/inventory_simulator --cov-report=term-missing

# Run specific test suite
pytest tests/test_observer.py -v  # Kalman filter tests
pytest tests/test_integration.py -v  # End-to-end tests
```

**Test Coverage**: 141 tests, >90% coverage

## Project Structure

```
inventory_system/
├── src/inventory_simulator/
│   ├── __init__.py           # Public API exports
│   ├── config.py             # SimulatorConfig dataclass
│   ├── types.py              # Event and result types
│   ├── utils.py              # Helper functions
│   ├── simulator.py          # Ground truth simulation
│   ├── observer.py           # Observer with Kalman filter
│   ├── analytics.py          # Metrics calculation
│   ├── runner.py             # Simulation orchestration
│   └── visualization.py      # Matplotlib plotting
├── tests/
│   ├── test_config.py        # Configuration tests
│   ├── test_simulator.py     # Simulator tests
│   ├── test_observer.py      # Observer & Kalman filter tests
│   ├── test_analytics.py     # Analytics tests
│   ├── test_runner.py        # Runner tests
│   └── test_integration.py   # End-to-end integration tests
├── examples/
│   ├── basic_simulation.py       # Simple text demo
│   └── visualization_demo.py     # Full visualization showcase
├── main.py                   # Main demonstration script
├── README.md                 # This file
└── pyproject.toml           # Package configuration
```

## Educational Value

This project is designed for **learning Kalman filters** through:

1. **Simple 1D State**: Easier to understand than complex multi-dimensional filters
2. **Clear Dynamics**: Conservation constraint makes behavior intuitive
3. **Visible Convergence**: Watch uncertainty decrease and estimates improve
4. **Practical Problem**: Inventory management is relatable
5. **Complete Implementation**: Read the code, run the tests, see the math

### Key Concepts Demonstrated

- **State Estimation**: Inferring hidden state from noisy observations
- **Uncertainty Quantification**: Tracking confidence in estimates
- **Sensor Fusion**: Combining multiple observations over time
- **Prediction vs Correction**: Balance between model and measurements
- **Partial Observability**: Operating with incomplete information
- **Conservation Laws**: Using constraints to improve estimation

## Advanced Usage

### Custom Measurement Noise

Modify the Kalman filter measurement noise model:

```python
# In observer.py, line ~108
R = 10.0 + 0.5 * self._estimates['uncertainty'].sum()

# Try different models:
R = base_noise + alpha * max_uncertainty
R = base_noise * (1 + beta * avg_uncertainty)
```

### Different Movement Patterns

Create non-uniform movement probabilities:

```python
# Modify Simulator.step() for spatial gradients
movement_prob = base_prob * (1 + 0.1 * shelf_id / num_shelves)
```

### Multiple Observers

Extend to multiple observers with different patterns:

```python
observer1 = Observer(config)  # Round-robin starting shelf 1
observer2 = Observer(config)  # Round-robin starting shelf 10
# Combine observations with sensor fusion
```

## Contributing

Contributions welcome! Areas for enhancement:

- Multi-dimensional Kalman filter (estimate per-shelf quantities)
- Extended Kalman Filter (EKF) for nonlinear dynamics
- Particle filter comparison
- Adaptive noise estimation
- Real-world inventory data integration

## License

MIT License - See LICENSE file for details

## Citation

If you use this project for research or education, please cite:

```bibtex
@software{inventory_simulator_kalman,
  title={Inventory Simulator with Kalman Filter},
  author={Your Name},
  year={2025},
  url={<repository-url>}
}
```

## See Also

- **Blog Post**: [Understanding Kalman Filters Through Inventory Management](BLOG.md)
- **Kalman Filter Resources**: [kalmanfilter.net](https://www.kalmanfilter.net/)
- **Sensor Fusion**: [Probabilistic Robotics](http://www.probabilistic-robotics.org/)

---

**Questions?** Open an issue or discussion on GitHub!
